# testcontainers

Spring Boot 환경에서 testcontainers 적용하기 위한 방법을 정리한다.

## testcontainers

대부분의 애플리케이션 서비스는 다른 서비스의 의존성을 가지고 운영된다. 간단한 예시로 데이터 저장을 위한 DB, 소셜 로그인을 위한 서버 호출 등을 통해 유기적으로 이루워져 있다.
즉 하나의 독립적인 서버 환경에서는 원할한 서비스를 운영하는 것은 어려운 일이다. 
이러한 외부 의존성들은 애플리케이션 개발에 많은 편의성을 제공해주지만 우리가 제어할 수 없는 영역이 늘어날수록 통합 테스트에 대한 편의성은 줄어든다. 

> 통합 테스트란?
> 
> 애플리케이션의 모든 구성 요소가 예상대로 작동하는지 확인하는 유형의 테스트이다.

만약 우리가 `RDBMS` 중 하나인 `MySQL`을 활용하여 서비스의 데이터를 관리한다고 가정한다. 통합 테스트를 진행하려면 우리 서비스에 연동된 MySQL에 데이터를 CRUD 할 수 있어야 한다.
이러한 DB 연동 방법에는 여러가지가 있는데 몇 가지 방법을 추려보았다.

### 실제 운영 중인 DB에 직접 접근하여 통합 테스트

실제 운영 중인 서비스에서 달성할 수 있는 가장 간단한 방법이다. 안정적으로 운영 중인 서버로 DB 드라이버를 연동하고 그대로 테스트 코드를 작성하면 된다.
다만 이 방식의 가장 큰 단점은 실제 운영 데이터에 통합 테스트 중 발생한 데이터가 섞이게 되는 것이다. 
또한 테스트는 여러 번 수행 되더라도 동일한 결과를 보여줘야 하기 때문에 `멱등성`을 잘 지키는 것이 중요하다.

> 멱등성
> 
> 수학이나 전산학에서 연산의 한 성질을 나타내는 것으로, 연산을 여러 번 적용하더라도 결과가 달라지지 않는 성질

이 멱등성을 지키기 위해서는 테스트 중 변경된 사항을 찾아 테스트 이전 상태로 바꿔줘야 한다. 이 작업은 DB 모델링에 따라 매우 복잡한 작업이 될 수 있다.
또한 운영 중인 서비스 데이터에 직접적인 영향이 생길 수 있기 때문에 추천하지 않는 방법이다.

### 임베디드 형태의 DB 활용

일부 DB는 임베디드 형태의 테스트를 제공하기도 한다. 

 * [h2database](https://github.com/h2database/h2database)
 * [wix-embedded-mysql](https://github.com/wix-incubator/wix-embedded-mysql)

이러한 임베디드 형태의 DB는 스프링 서버와 라이프 사이클을 공유하기 때문에 `멱등성`을 지키기가 쉽다. 단순히 테스트를 진행할 때마다 DB 안에 모든 데이터를 초기화하면 되기 때문이다.
또한 여러 명이서 한 프로젝트를 진행할 경우 추가적인 설정 없이 바로 서버 실행 및 테스트가 가능 하다는 장점이 있다.

하지만 임베디드 형태의 DB의 경우 DB의 버전 변경에 적절히 대응해야 하지만 실제 DB 서버와는 차이가 있기 때문에 한계가 존재한다. 
실제 서비스에서 운영 중인 DB와 버전, 동작 방식이 다를 수 있기 때문에 실제와 유사한 환경에서 테스트하는데 한계가 있다.
같은 결과가 나오길 기대 했지만 내부 동작 방식에 대한 차이로 인해 서로 다른 결과가 나올 가능성이 있기 때문이다.
[wix-embedded-mysql](https://github.com/wix-incubator/wix-embedded-mysql) 문서를 살펴보면 지원이 중단된 것을 확인할 수 있다.

![](images/1.png)

### 로컬에서 동일 버전 DB 설치 

다음은 로컬 환경에 운영 중인 DB 서버와 동일한 버전을 설치해서 연동하는 것이다. 서버를 직접 설치도 가능하고 Docker와 같은 컨테이너 기술을 통해 실행하는 것도 가능하다.
이 방식의 가장 큰 장점은 실제 운영 DB 서버와 동일한 환경에서 테스트할 수 있다는 것이다. 또한 로컬에서 수행되기 때문에 DB 테이블에 대한 조작을 자유롭게 할 수 있다.

하지만 이에 대한 단점은 해당 프로젝트를 개발하는 모든 팀원이 개별적으로 설치하고 관리해야 한다는 것이다. 그나마 Docker 컨테이너를 사용하면 도커 이미지를 통해 이러한 단점을 어느정도 상쇄시킬 수 있다.

![](images/2.png)

### testcontainers 활용한 통합 테스트 환경 구성

[testcontainers](https://testcontainers.com/)는 테스트 환경을 도커 컨테이너로 제공하는 라이브러리이다. 데이터베이스, 웹 서버, 카프카 등 
다양한 종류의 컨테이너를 코드 레벨에서 제공해준다. 이러한 컨테이너는 테스트를 실행하는 동안 초기화되고, 완료되면 자동으로 제거된다. 
즉 테스트 진행과 동일한 라이프사이클을 가지고 동작한다. 이를 통해 테스트 환경의 일관성을 유지하여 멱등성을 잘 지킬 수 있도록 도와준다.

![img.png](images/3.png)

## References.

 * [멱등법칙](https://ko.wikipedia.org/wiki/%EB%A9%B1%EB%93%B1%EB%B2%95%EC%B9%99)
